<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Lecture12:ZKEVM - World of Z2O-K7E</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../../index.html">TOC</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Halo2</li><li class="chapter-item expanded "><a href="../../halo2/0xparc halo2.html"><strong aria-hidden="true">1.</strong> 0xparc halo2</a></li><li class="chapter-item expanded "><a href="../../halo2/1. Simple Examples.html"><strong aria-hidden="true">2.</strong> 1.Simple Examples</a></li><li class="chapter-item expanded "><a href="../../halo2/2. Fibonacci (halo2-hope).html"><strong aria-hidden="true">3.</strong> 2.Fibonacci(halo2-hope)</a></li><li class="chapter-item expanded "><a href="../../halo2/3. Fibonacci (ex1+ex2).html"><strong aria-hidden="true">4.</strong> 3. Fibonacci (ex1+ex2)</a></li><li class="chapter-item expanded "><a href="../../halo2/4. IsZero Check (ex3).html"><strong aria-hidden="true">5.</strong> 4. IsZero Check (ex3)</a></li><li class="chapter-item expanded "><a href="../../halo2/halo2 Source Code.html"><strong aria-hidden="true">6.</strong> halo2 Source Code</a></li><li class="chapter-item expanded "><a href="../../halo2/StarLi halo2.html"><strong aria-hidden="true">7.</strong> StarLi halo2</a></li><li class="chapter-item expanded affix "><li class="part-title">Folding Schemes</li><li class="chapter-item expanded "><a href="../../Nova/SuperNova.html"><strong aria-hidden="true">8.</strong> SuperNova</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">zk-everything</li><li class="chapter-item expanded "><a href="../../zk-everything/BabySNARK tutorial.html"><strong aria-hidden="true">9.</strong> BabySNARK tutorial</a></li><li class="chapter-item expanded "><a href="../../zk-everything/zk-learning-miles/KZG.html"><strong aria-hidden="true">10.</strong> KZG</a></li><li class="chapter-item expanded "><a href="../../zk-everything/zk-learning-miles/Lecture1:Overview about Zeroknowledge.html"><strong aria-hidden="true">11.</strong> Lecture1:Overview about Zeroknowledge</a></li><li class="chapter-item expanded "><a href="../../zk-everything/zk-learning-miles/Lecture2:Introduction to Modern SNARKs.html"><strong aria-hidden="true">12.</strong> Lecture2:Introduction to Modern SNARKs</a></li><li class="chapter-item expanded "><a href="../../zk-everything/zk-learning-miles/Lecture12:ZKEVM.html" class="active"><strong aria-hidden="true">13.</strong> Lecture12:ZKEVM</a></li><li class="chapter-item expanded "><a href="../../zk-everything/zk-learning-miles/Lecture16:Hardware acceleration.html"><strong aria-hidden="true">14.</strong> Lecture16:Hardware acceleration</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">ZKP Public Goods</li><li class="chapter-item expanded "><a href="../../public goods/第二章.html"><strong aria-hidden="true">15.</strong> ch2</a></li><li class="chapter-item expanded "><a href="../../public goods/4-Proving-System.html"><strong aria-hidden="true">16.</strong> ch4-Proving System</a></li><li class="chapter-item expanded "><a href="../../public goods/5-plonk-intro.html"><strong aria-hidden="true">17.</strong> ch5-plonk-intro</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">World of Z2O-K7E</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="zk-learning-lecture-12zk--evm"><a class="header" href="#zk-learning-lecture-12zk--evm">ZK-learning lecture 12:ZK- EVM</a></h1>
<h1 id="background-and-motivation"><a class="header" href="#background-and-motivation">Background and motivation</a></h1>
<h2 id="the-diagram-of-layer1-blockchain"><a class="header" href="#the-diagram-of-layer1-blockchain">The diagram of Layer1 blockchain</a></h2>
<p><img src="static/TbRYb9TrIo4phnxXR0ZcaDAMnJg.png" alt="" /></p>
<h3 id="区块链简单介绍"><a class="header" href="#区块链简单介绍">区块链简单介绍:</a></h3>
<p>区块链网络由许多节点组成，通常有大量的节点用于指定，它们通过 P2P 网络互连，所有节点保持与上图红框显示的相同状态.这是一个类似于共享账本的数据库，因此可以将余额或者一些程序代码放在这里.然后使用名为 Merkle tree 的数据结构将所有这些信息存储在列表中.从而得到一个状态路由.</p>
<p>然后对状态路由取摘要来代表所有的状态.每个节点都需要维护相同的数据库.此外节点还将运行称为 EVM 的相同软件进行一些计算并更新状态路由，</p>
<p>区块链也称为 world computer 这个词，因为任何人都可以使用它来运行任何接近去中心化的程序，而运行在区块链之上的程序称为智能合约，因此 evm 将从节点计算机加载 merkle 树叶子结点中的数据到 Storage 中重写这棵树并获得新的状态路由</p>
<h3 id="发送交易"><a class="header" href="#发送交易">发送交易:</a></h3>
<p><img src="static/T1SZbWqwYoNkprx4RsocTq8Pnwh.png" alt="" /></p>
<p>用户发送交易至区块链中,交易会在 p2p 网络中传播,通过共识算法在每个时隙中选择一个提案， 这个提案将把它收到的许多交易打包到一个块中，同时以交易作为输入运行 evm 并更新状态路由，然后出块.在看到这个块被提交后，网络中的其他节点将下载这个块并重新通过 EVM 执行该块内的交易，就状态路由达成共识.这样始终维护相同的数据库.</p>
<h3 id="layer1-特点"><a class="header" href="#layer1-特点">Layer1 特点:</a></h3>
<p>优点</p>
<p><strong>Secure</strong>:交易将由不同的节点执行多次 <strong>Decentralized</strong></p>
<p>缺点</p>
<p><strong>Expensive  Slow</strong></p>
<h3 id="zk-rollup"><a class="header" href="#zk-rollup">zk-rollup</a></h3>
<p><img src="static/O49NbxyOToIM0RxWZHjct6JXnPf.png" alt="" /></p>
<p>ZK-rollup 是一种扩展解决方案，用于解决 EVM 的可扩展性问题.</p>
<p>ZK-rollup 不像 Layer1 广播所有交易，以及拥塞且昂贵的 P2P 网络,其有一个单独的 Layer2 网络层，可以更加中心化.</p>
<p>zk-Rollup 的基本思想是将大量交易聚合到一个 Rollup 块中，并为该链下的块生成 <code>简洁,公开,可验证</code> 的证明。然后 Layer 1 上的智能合约只需要验证证明并<strong>直接应用</strong>更新的状态，而无需重新执行那些交易。这可以帮助节省一个数量级的 gas 费用，以及提升一个数量级别的网络吞吐.因为验证证明比重新执行计算便宜得多。另一个节省来自数据压缩（即只保留最小的链上数据用于验证).</p>
<p>这样做与原来的安全性是**等效的.**背后的原理依赖于 zk.</p>
<p><img src="static/TezmbkTqfo1TGhxCznDcAzABn3c.png" alt="" /></p>
<p><strong>编写困难</strong></p>
<p>但是构造这样一个 Prover 是困难的,对于某些计算的证明，首先需要以电路形式编写所有程序逻辑，</p>
<p>也就是用加法乘法和类似的非常底层的方法断言.电路强调非常复杂的逻辑，包括 for Loop ,if else 和所有程序.语法非常复杂.此外 <code>一个电路对应一个程序</code>，这意味着对于不同的应用程序开发人员，需要实现自己的电路.电路也需要通过一个非常严格的安全测试审计，这需要很长的开发时间.</p>
<p><strong>兼容</strong> <code>:</code> 比如一个 Prover 无法同时包含来自 uniswap 与 optiswap 上的交易.</p>
<p>所以需要 zkevm.</p>
<h3 id="zkevm-概念"><a class="header" href="#zkevm-概念">zkevm 概念</a></h3>
<p><img src="static/Vzz2b87ldouf3yxIRCtcbKWqn3g.png" alt="" /></p>
<p>zkEVM 是一种虚拟机，通过 zk 证明计算和现有以太坊基础设施<strong>兼容</strong>的方式执行智能合约交易。这使它们能够成为零知识汇总、第 2 层扩展解决方案的一部分，从而提高交易吞吐量，同时降低成本</p>
<p>如果第 2 层可以运行为以太坊环境创建的程序而无需修改底层智能合约逻辑，则该 Layer2 是 EVM 兼容的。这使得第 2 层与现有的以太坊智能合约模式、代币标准和工具兼容。与 EVM 兼容对于这些第 2 层的广泛采用非常重要，因为它使熟悉以太坊 Solidity 编程语言的开发人员能够使用他们习惯的的工具构建高度可扩展的应用程序。</p>
<p><strong>但是</strong> zkevm 很难编写,有以下几点原因</p>
<ul>
<li>**第一，<strong><strong>EVM</strong></strong> 对椭圆曲线的支持有限。**目前，EVM 仅支持 BN254 配对。由于不直接支持循环椭圆曲线，因此很难进行递归证明。在此之下也很难使用其他专用协议。验证算法必须是 EVM 友好的。</li>
<li>**第二，<strong><strong>EVM</strong></strong>字节为 256 位。**EVM 在 256 位整数上运行（就像大多数正常 VM 在 32-64 位整数上运行），而 zk 证明“天生地”大多在素数上工作。在电路内部进行“不匹配的字段计算”需要范围证明，这将在每个 EVM 操作中增加约 100 个约束。这将使 EVM 电路大小扩大两个数量级。</li>
<li>**第三，<strong><strong>EVM</strong></strong> 有很多特殊的<strong><strong>操作码</strong></strong>。**EVM 与传统 VM 不同，它有许多特殊的操作码，例如 <code>CALL</code>。它也有与执行上下文和 gas 相关的错误类型。这给电路设计带来了新的挑战。</li>
<li>**第四，<strong><strong>EVM</strong></strong> 是基于堆栈的<strong><strong>虚拟机</strong></strong>。**SyncVM (zksync) 和 Cario (starkware) 的架构在基于寄存器的模型中定义了自己的中间表示(IR,Intermediate Representation)/代数中间表示(AIR, Algebraic Intermediate Representation)。他们构建了一个专门的编译器，将智能合约代码编译成一新的 zk 友好 IR。他们的方案是语言兼容而不是原生 EVM 兼容。基于堆栈的模型和直接支持原生链工具更难证明。</li>
<li>**第五，以太坊存储层带来巨大开销。**以太坊存储层高度依赖 Keccak 和巨大的 MPT，它们都不是 zk 友好的，并且需要巨大的证明开销。例如，Keccak 哈希比电路中的 Poseidon 哈希大 1000 倍。但是，如果将 Keccak 替换为另一个哈希算法，则会对现有的以太坊基础设施造成一些兼容性问题。</li>
<li>**第六，基于机器的证明需要巨大的开销。**即使能够妥善处理上述所有问题，仍然需要找到一种有效的方法将它们组合在一起以获得一个完整的 EVM 电路。正如我们上一节中所提到的，即使像 <code>add</code> 这样简单的操作码也需要整个 EVM 电路的开销</li>
</ul>
<p>以下技术的发展使得 zkevm 得以落地</p>
<ul>
<li>**多项式承诺的使用。**在过去的几年里，大多数简洁零知识证明协议都坚持使用 R1CS，将 PCP 查询编码在特定于应用程序的可信设置中。电路大小通常会爆炸，且不能进行许多自定义的优化，因为每个约束的项数需要为 2（双线性配对只允许指数中的一次乘法）。使用多项式承诺方案，可以通过通用设置甚至透明设置将约束提升到任何项数。这为后端的选择提供了极大的灵活性。</li>
<li>**查找表参数和自定义配置的出现。**另一个强大的优化来自查找表的使用。该优化首先在 Arya 中提出，然后 Plookup 中进一步升级。这可以为 zk 不友好的原语（即，AND、XOR 等按位运算）节省很多成本。自定义配置可以高效地进行高项数的约束。TurboPlonk 和 UltraPlonk 定义了优雅的程序语法，以便更轻松地使用查找表和定制配置。这对于减少 EVM 电路的开销非常有帮助。</li>
<li>**递归****证明越来越可行。**递归证明在过去需要巨大的开销，因为它依赖于特殊的配对友好的循环椭圆曲线,这引入了很大的计算开销。然而，更多的技术在不牺牲效率的情况下使这成为可能。例如，Halo 可以避免对配对友好曲线的需要，并使用特殊的内积参数来摊销递归成本。Aztec 表明可以直接对现有协议进行证明聚合（查找表可以减少非原生字段操作的开销，从而可以使验证电路更小）。它可以极大地提高支持的电路大小的可扩展性。</li>
<li><strong>硬件加速使证明更加高效。Scroll</strong> 为证明者制造了最快的 GPU 和 ASIC/FPGA 加速器。关于 ASIC 证明者的论文，今年已经被最大的计算机会议（ISCA）收录。GPU 证明器比 Filecoin 的实现快大约 5 到 10 倍。这可以大大提高证明者的计算效率。</li>
</ul>
<h3 id="zkevm-分类"><a class="header" href="#zkevm-分类">ZKEVM 分类</a></h3>
<p><img src="static/R0tdb0fssoyKlqxLuCScOYGfnsg.png" alt="" /></p>
<ul>
<li>Language level:采用高级语言（例如 Solidity 或 Vyper）编写的代码，并将其编译为旨在支持零知识证明的语言。本质上，它们相当于高级语言，但不是实际的 EVM。尽管合约可能不具有相同的地址，但这可以更快地生成证明并降低成本 <code> Starknet</code></li>
<li>Bytecode level:牺牲了一些 EVM 功能，以实现更轻松的应用程序开发和证明生成，例如对预编译、VM 内存、堆栈以及智能合约代码处理方式的更改。虽然大多数以太坊应用程序都可以在这种环境中运行，但有些应用程序可能需要重写 <code>Scroll Polygen</code></li>
<li>Consensus level:不会改变当前以太坊系统的任何部分，从而更容易生成零知识证明。这使得它们与所有以太坊本机应用程序完全兼容，并允许重复使用区块浏览器和执行客户端等工具。然而，以太坊协议的某些部分需要大量计算来生成零知识证明，导致 zkEVM 的证明时间较长</li>
</ul>
<p><a href="https://vitalik.eth.limo/general/2022/08/04/zkevm.html">也可以参考 V 神的 4 种分类 </a></p>
<p><img src="static/HaNmbcORaoHiuNxJBE6cJlJ1nPh.png" alt="" /></p>
<h1 id="build-a-zkevm-from-scratch"><a class="header" href="#build-a-zkevm-from-scratch">Build a zkEVM from scratch</a></h1>
<h1 id="interesting-research-problems"><a class="header" href="#interesting-research-problems">Interesting research problems</a></h1>
<h1 id="other-applications-using-zkev"><a class="header" href="#other-applications-using-zkev">Other applications using zkEV</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../zk-everything/zk-learning-miles/Lecture2:Introduction to Modern SNARKs.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../zk-everything/zk-learning-miles/Lecture16:Hardware acceleration.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../zk-everything/zk-learning-miles/Lecture2:Introduction to Modern SNARKs.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../zk-everything/zk-learning-miles/Lecture16:Hardware acceleration.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
